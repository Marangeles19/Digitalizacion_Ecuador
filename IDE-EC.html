<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Índice de Digitalización Económica del Ecuador</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --brand1:#0B5FFF;
      --brand2:#00BFA6;
      --brand3:#7C3AED;

      --bg:#F6F8FC;
      --bg2:#EEF3FF;
      --card: rgba(255,255,255,.92);
      --card2: rgba(255,255,255,.78);
      --line: rgba(11,95,255,.14);

      --txt:#0B1320;
      --muted:#4A607C;

      --shadow: 0 18px 55px rgba(16, 24, 40, .10);
      --shadow2: 0 10px 28px rgba(16, 24, 40, .10);
      --radius: 18px;
      --radius2: 14px;

      --focus: rgba(0,191,166,.20);

      --grid: rgba(15, 23, 42, .08);
      --tick: rgba(15, 23, 42, .65);

      --pillBg: rgba(11,95,255,.08);
      --pillLine: rgba(11,95,255,.18);

      --btnBg: rgba(11,95,255,.08);
      --btnLine: rgba(11,95,255,.18);

      --inputBg: rgba(255,255,255,.92);
      --inputLine: rgba(11,95,255,.18);
    }

    [data-theme="dark"]{
      --bg:#070A12;
      --bg2:#0B1020;
      --card: rgba(15, 24, 48, .68);
      --card2: rgba(10, 16, 35, .50);
      --line: rgba(124, 179, 255, .20);

      --txt:#ECF3FF;
      --muted:#AFC0E3;

      --shadow: 0 18px 55px rgba(0,0,0,.40);
      --shadow2: 0 10px 28px rgba(0,0,0,.34);

      --grid: rgba(124,179,255,.14);
      --tick: rgba(175,192,227,.95);

      --pillBg: rgba(77,163,255,.14);
      --pillLine: rgba(77,163,255,.22);

      --btnBg: rgba(10, 16, 35, .35);
      --btnLine: rgba(124,179,255,.22);

      --inputBg: rgba(6,10,24,.62);
      --inputLine: rgba(124,179,255,.26);
    }

    body{
      background:
        radial-gradient(900px 620px at 12% -10%, color-mix(in srgb, var(--brand1) 18%, transparent), transparent 55%),
        radial-gradient(900px 620px at 90% 0%, color-mix(in srgb, var(--brand2) 14%, transparent), transparent 60%),
        radial-gradient(900px 620px at 60% 120%, color-mix(in srgb, var(--brand3) 10%, transparent), transparent 65%),
        linear-gradient(180deg, var(--bg2), var(--bg));
      color: var(--txt);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .container-fluid{ position: relative; }

    .glass{
      background: var(--card) !important;
      border: 1px solid var(--line) !important;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      border-radius: var(--radius) !important;
    }
    .glass-soft{
      background: var(--card2) !important;
      border: 1px solid color-mix(in srgb, var(--line) 85%, transparent) !important;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      box-shadow: var(--shadow2);
      border-radius: var(--radius2) !important;
    }

    .muted{ color: var(--muted) !important; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .sidebar{
      width: 320px;
      min-height: calc(100vh - 1.5rem);
      position: sticky;
      top: 12px;
    }
    @media (max-width: 992px){
      .sidebar{ width: 100%; min-height: auto; position: static; top: 0; }
    }

    .topHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      background: linear-gradient(135deg,
        color-mix(in srgb, var(--brand1) 14%, transparent),
        color-mix(in srgb, var(--brand2) 10%, transparent)
      );
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 16px 18px;
      box-shadow: var(--shadow);
    }
    .sectionTitle{
      font-weight: 900;
      letter-spacing: .2px;
      margin: 0;
      line-height: 1.15;
    }
    .subTitle{
      margin: 4px 0 0;
      font-size: .95rem;
      color: var(--muted);
    }

    .brandPill{
      display:inline-flex;
      align-items:center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--pillLine);
      background: var(--pillBg);
      color: var(--txt);
    }
    .brandDot{
      width: 10px; height: 10px;
      border-radius: 99px;
      background: linear-gradient(135deg, var(--brand1), var(--brand2));
      box-shadow: 0 0 0 6px color-mix(in srgb, var(--brand2) 12%, transparent);
    }

    .btn-soft{
      background: var(--btnBg);
      border: 1px solid var(--btnLine);
      color: var(--txt);
      border-radius: 12px;
      transition: transform .08s ease, border-color .2s ease, background .2s ease;
    }
    .btn-soft:hover{
      border-color: color-mix(in srgb, var(--brand1) 55%, transparent);
      transform: translateY(-1px);
      color: var(--txt);
    }
    .btn-soft:focus{
      box-shadow: 0 0 0 .2rem var(--focus);
    }

    .btn-warn{
      background: color-mix(in srgb, #FFC107 16%, transparent);
      border: 1px solid color-mix(in srgb, #FFC107 35%, transparent);
      color: var(--txt);
      border-radius: 12px;
    }
    .btn-warn:hover{
      border-color: color-mix(in srgb, #FFC107 60%, transparent);
      color: var(--txt);
      transform: translateY(-1px);
    }

    .themeToggle{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--btnLine);
      background: var(--btnBg);
      user-select:none;
      cursor:pointer;
    }
    .themeToggle i{ font-size: 1rem; }
    .switch{
      width: 44px; height: 24px;
      border-radius: 999px;
      background: color-mix(in srgb, var(--brand1) 18%, transparent);
      border: 1px solid var(--btnLine);
      position: relative;
      flex: 0 0 auto;
    }
    .knob{
      width: 18px; height: 18px;
      border-radius: 99px;
      position:absolute;
      top: 50%;
      transform: translateY(-50%);
      left: 3px;
      background: linear-gradient(135deg, var(--brand1), var(--brand2));
      transition: left .18s ease;
    }
    [data-theme="dark"] .knob{ left: 23px; }

    .nav-pills .nav-link{
      color: var(--txt);
      border: 1px solid var(--btnLine);
      background: var(--btnBg);
      margin-bottom: .6rem;
      border-radius: 14px;
      padding: 12px 12px;
      transition: transform .08s ease, border-color .2s ease, background .2s ease;
      text-align: left;
    }
    .nav-pills .nav-link:hover{
      border-color: color-mix(in srgb, var(--brand1) 55%, transparent);
      transform: translateY(-1px);
    }
    .nav-pills .nav-link.active{
      background: linear-gradient(135deg,
        color-mix(in srgb, var(--brand1) 14%, transparent),
        color-mix(in srgb, var(--brand2) 10%, transparent)
      );
      border-color: color-mix(in srgb, var(--brand1) 55%, transparent);
      color: var(--txt);
    }

    .badge-soft{
      background: var(--pillBg);
      border: 1px solid var(--pillLine);
      color: var(--muted);
      font-weight: 600;
    }

    .divider{
      height: 1px;
      background: color-mix(in srgb, var(--line) 85%, transparent);
      margin: 14px 0;
    }

    .kpi{ min-height: 110px; }
    .kpi.kpi-highlight{
      min-height: 160px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      padding: 22px !important;
      border: 1px solid color-mix(in srgb, var(--brand1) 26%, transparent) !important;
      background: linear-gradient(135deg,
        color-mix(in srgb, var(--brand1) 10%, transparent),
        color-mix(in srgb, var(--brand2) 8%, transparent)
      ) !important;
    }
    .kpi .big{
      font-size: 1.45rem;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .kpi .big.brandNumber{
      font-size: clamp(2.1rem, 3.4vw, 3.0rem);
      line-height: 1.05;
      background: linear-gradient(135deg, var(--brand1), var(--brand2));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow: 0 10px 25px color-mix(in srgb, var(--brand1) 16%, transparent);
    }

    .form-control, .form-select{
      background: var(--inputBg) !important;
      border: 1px solid var(--inputLine) !important;
      color: var(--txt) !important;
      border-radius: 14px;
    }
    .form-control::placeholder{ color: color-mix(in srgb, var(--muted) 75%, transparent); }
    .form-control:focus, .form-select:focus{
      border-color: color-mix(in srgb, var(--brand2) 60%, transparent) !important;
      box-shadow: 0 0 0 .2rem var(--focus) !important;
    }

    .chartBox{ height: 340px; }
    @media (max-width: 576px){ .chartBox{ height: 250px; } }

    .table-dark{
      --bs-table-bg: color-mix(in srgb, var(--card2) 90%, transparent);
      --bs-table-border-color: color-mix(in srgb, var(--line) 80%, transparent);
      --bs-table-color: var(--txt);
    }

    #summaryWrap { overflow-x:auto; }
    #summaryTable{
      width: 100%;
      table-layout: fixed;
      min-width: 740px;
    }
    #summaryTable th, #summaryTable td{
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: .92rem;
    }

    .micro{
      font-size: .85rem;
      color: color-mix(in srgb, var(--muted) 90%, transparent);
    }

    .benefitText{
      font-size: 1.05rem;
      line-height: 1.6;
    }
    .benefitText p{ margin: .55rem 0; }
    .benefitText .benefit-section{
      margin: 1rem 0 .45rem;
      font-weight: 900;
      letter-spacing: .2px;
      padding-bottom: .35rem;
      border-bottom: 1px solid color-mix(in srgb, var(--line) 80%, transparent);
    }
    .benefitText .benefit-sub{
      margin: .9rem 0 .35rem;
      font-weight: 800;
    }
    .benefit-list{
      margin: .35rem 0 .8rem 1.2rem;
    }
    .benefit-list li{ margin: .25rem 0; }

    .logoGrid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }
    .logoCard{ display:flex; align-items:center; gap: 12px; }
    .logoWrap{
      width: 54px; height: 54px;
      border-radius: 14px;
      display:grid;
      place-items:center;
      background: color-mix(in srgb, var(--btnBg) 85%, transparent);
      border: 1px solid color-mix(in srgb, var(--btnLine) 80%, transparent);
      overflow:hidden;
      flex: 0 0 auto;
    }
    .logoWrap img{ width: 100%; height: 100%; object-fit: contain; padding: 8px; }
    .logoFallback{
      width: 100%; height: 100%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      letter-spacing: .8px;
      color: var(--txt);
      background: linear-gradient(135deg,
        color-mix(in srgb, var(--brand1) 20%, transparent),
        color-mix(in srgb, var(--brand2) 16%, transparent)
      );
    }
    .logoName{ font-weight: 800; }
  </style>
</head>

<body>
<div class="container-fluid py-3">
  <div class="row g-3">

    <!-- SIDEBAR -->
    <aside class="col-lg-auto sidebar">
      <div class="p-3 glass h-100">
        <div class="d-flex align-items-center justify-content-between gap-2 mb-3">
          <div>
            <div class="fw-bold">Menú</div>
            <div class="micro">IDE–EC · GOV · ACC · ECO · PAY · Beneficios</div>
          </div>
          <div class="brandPill">
            <span class="brandDot"></span>
            <span class="small fw-semibold">Panel</span>
          </div>
        </div>

        <div class="nav nav-pills flex-column" id="menu">
          <button class="nav-link active d-flex justify-content-between align-items-center" data-tab="ide" type="button">
            <span><i class="bi bi-diagram-3 me-2"></i>IDE–EC</span>
            <span class="badge badge-soft rounded-pill">pesos</span>
          </button>

          <button class="nav-link d-flex justify-content-between align-items-center" data-tab="gov" type="button">
            <span><i class="bi bi-bank me-2"></i>GOV</span>
            <span class="badge badge-soft rounded-pill">0–1</span>
          </button>

          <button class="nav-link d-flex justify-content-between align-items-center" data-tab="acc" type="button">
            <span><i class="bi bi-wifi me-2"></i>ACC</span>
            <span class="badge badge-soft rounded-pill">0–1</span>
          </button>

          <button class="nav-link d-flex justify-content-between align-items-center" data-tab="eco" type="button">
            <span><i class="bi bi-graph-up me-2"></i>ECO</span>
            <span class="badge badge-soft rounded-pill">%</span>
          </button>

          <button class="nav-link d-flex justify-content-between align-items-center" data-tab="pay" type="button">
            <span><i class="bi bi-credit-card me-2"></i>PAY</span>
            <span class="badge badge-soft rounded-pill">%</span>
          </button>

          <button class="nav-link d-flex justify-content-between align-items-center" data-tab="benef" type="button">
            <span><i class="bi bi-building-check me-2"></i>Beneficios</span>
            <span class="badge badge-soft rounded-pill">info</span>
          </button>
        </div>

        <div class="divider"></div>
        <div class="micro">
          <i class="bi bi-lightning-charge me-1"></i>
          Presentación: usa <b>Día</b> para proyectores brillantes y <b>Noche</b> para salas oscuras.
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="col">
      <div class="topHeader">
        <div>
          <h1 class="h4 sectionTitle">Índice de Digitalización Económica del Ecuador</h1>
          <p class="subTitle" id="pageDesc">IDE–EC: edita pesos y mira resultados.</p>
        </div>

        <div class="d-flex flex-wrap justify-content-end align-items-center gap-2">
          <div class="themeToggle" id="themeToggle" role="button" aria-label="Cambiar tema">
            <i class="bi bi-sun-fill" id="themeIcon"></i>
            <span class="small fw-semibold" id="themeLabel">Día</span>
            <span class="switch" aria-hidden="true"><span class="knob"></span></span>
          </div>

          <button class="btn btn-soft btn-sm" id="addYearBtn" type="button">
            <i class="bi bi-plus-circle me-1"></i>Año
          </button>
          <button class="btn btn-warn btn-sm" id="clearBtn" type="button">
            <i class="bi bi-trash3 me-1"></i>Limpiar
          </button>
        </div>
      </div>

      <!-- ✅ CALCULADORA -->
      <section class="mt-3" id="viewIndicator">
        <div class="row g-3">

          <!-- LEFT: INPUTS -->
          <div class="col-xl-5" id="leftPane">
            <div class="glass p-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="fw-bold">Datos por año</div>
                <span class="badge badge-soft rounded-pill">Panel</span>
              </div>

              <!-- ✅ Año con navegación -->
              <label class="form-label small muted mb-1">Año</label>
              <div class="d-flex gap-2 mb-3">
                <button class="btn btn-soft" type="button" id="prevYearBtn" title="Año anterior">
                  <i class="bi bi-chevron-left"></i>
                </button>

                <select class="form-select" id="yearSelect"></select>

                <button class="btn btn-soft" type="button" id="nextYearBtn" title="Año siguiente">
                  <i class="bi bi-chevron-right"></i>
                </button>
              </div>

              <!-- IDE ONLY -->
              <div class="glass-soft p-3 mb-3" id="blockIDE">
                <div class="d-flex justify-content-between align-items-baseline mb-2">
                  <div class="fw-bold">IDE–EC (pesos)</div>
                  <div class="small muted mono">IDE–EC = wGOV×GOV + wACC×ACC + wECO×ECO + wPAY×PAY</div>
                </div>

                <div class="row g-2">
                  <div class="col-6">
                    <label class="form-label small muted mb-1">GOV</label>
                    <input class="form-control" type="text" inputmode="decimal" data-key="wGOV" placeholder="Ej: 0.25 o 25">
                  </div>
                  <div class="col-6">
                    <label class="form-label small muted mb-1">ACC</label>
                    <input class="form-control" type="text" inputmode="decimal" data-key="wACC" placeholder="Ej: 0.30 o 30">
                  </div>
                  <div class="col-6">
                    <label class="form-label small muted mb-1">ECO</label>
                    <input class="form-control" type="text" inputmode="decimal" data-key="wECO" placeholder="Ej: 0.20 o 20">
                  </div>
                  <div class="col-6">
                    <label class="form-label small muted mb-1">PAY</label>
                    <input class="form-control" type="text" inputmode="decimal" data-key="wPAY" placeholder="Ej: 0.25 o 25">
                  </div>

                  <div class="mt-3">
                    <div class="small muted mb-2">
                      <i class="bi bi-link-45deg me-1"></i>Links / fuentes (PDF)
                    </div>
                    <div class="micro mt-2">
                      PDF aquí:
                      <a href="dataIDE-EC/Justificacion_Tecnica_IDE-EC_Ecuador.pdf" target="_blank" rel="noopener">Pesos</a>
                      
                      <a href="dataIDE-EC/nri-2025.pdf" target="_blank" rel="noopener"> ,Peaper_pesos</a>
                    </div>
                    <div class="micro mt-2">
                      PDF aquí:
                      <a href="dataIDE-EC/Justificacion_Tecnica_IDE-EC_Ecuador.pdf" target="_blank" rel="noopener">Formula</a>
                    </div>
                    <div class="micro mt-2">
                      PDF aqui:
                      <a href="dataIDE-EC/Sustento Metodológico de las Fórmulas del IDE.pdf" target="_blank" rel="noopener">Sustento_formulas</a>
                    </div>
                  </div>
                </div>

                <div class="small muted mt-2" id="wNote"></div>
              </div>

              <!-- ✅ GOV ONLY (CORREGIDO: divs bien cerrados / bien anidados) -->
              <div class="glass-soft p-3 mb-3 d-none" id="blockGOV">
                <div class="d-flex justify-content-between align-items-baseline mb-2">
                  <div class="fw-bold">GOV</div>
                  <div class="small muted">OSI/TII/HCI (0–1)</div>
                </div>

                <div class="row g-2">
                  <div class="col-6">
                    <label class="form-label small muted mb-1">OSI</label>
                    <input class="form-control" type="text" inputmode="decimal" data-key="OSI">
                  </div>
                  <div class="col-6">
                    <label class="form-label small muted mb-1">TII</label>
                    <input class="form-control" type="text" inputmode="decimal" data-key="TII">
                  </div>
                  <div class="col-6">
                    <label class="form-label small muted mb-1">HCI</label>
                    <input class="form-control" type="text" inputmode="decimal" data-key="HCI">
                  </div>
                </div>

                <div class="mt-3">
                  <div class="small muted mb-2">
                    <i class="bi bi-link-45deg me-1"></i>Links / fuentes (PDF)
                  </div>
                  <div class="micro mt-2">
                    PDF aquí:
                    <a href="dataGOV/Metodologia_GOV_Años_Impares.pdf" target="_blank" rel="noopener">Años_impares</a>
                    <a href="dataGOV/15.2.1_Ficha-Metodologica_Indice-Gobierno-Electronico.pdf" target="_blank" rel="noopener"> , Ficha_metodologica</a>
                    <a href="dataGOV/Technical Appendix 2024_SP Web R2.pdf" target="_blank" rel="noopener"> ,Naciones_Unidas_E-Gobierno</a>
                  </div>
                </div>
              </div>

              <!-- ACC ONLY -->
              <div class="glass-soft p-3 mb-3 d-none" id="blockACC">
                <div class="d-flex justify-content-between align-items-baseline mb-2">
                  <div class="fw-bold">ACC</div>
                  <div class="small muted mono">ACC=(IH+UI+CA+SP+(1-AI))/5</div>
                </div>
                <div class="row g-2">
                  <div class="col-6">
                    <label class="form-label small muted mb-1">IH</label>
                    <input class="form-control" type="text" inputmode="decimal" data-key="IH">
                  </div>
                  <div class="col-6">
                    <label class="form-label small muted mb-1">UI</label>
                    <input class="form-control" type="text" inputmode="decimal" data-key="UI">
                  </div>
                  <div class="col-6">
                    <label class="form-label small muted mb-1">CA</label>
                    <input class="form-control" type="text" inputmode="decimal" data-key="CA">
                  </div>
                  <div class="col-6">
                    <label class="form-label small muted mb-1">SP</label>
                    <input class="form-control" type="text" inputmode="decimal" data-key="SP">
                  </div>
                  <div class="col-6">
                    <label class="form-label small muted mb-1">AI</label>
                    <input class="form-control" type="text" inputmode="decimal" data-key="AI">
                  </div>
                </div>

                <div class="micro mt-2" id="accBreakdown">Completa IH, UI, CA, SP y AI para ver el desglose.</div>

                <div class="mt-3">
                  <div class="small muted mb-2">
                    <i class="bi bi-link-45deg me-1"></i>Links / fuentes (PDF)
                  </div>
                  <div class="micro mt-2">
                    PDF aquí:
                    <a href="dataACC/202407_Tecnologia_de_la_Informacion_y_Comunicacion-TICs.pdf" target="_blank" rel="noopener">Encuesta_Nacional</a>
                    <a href="dataACC/DATOS_CALCULADOS.xlsx" target="_blank" rel="noopener"> ,Datos_calculados</a>
                  </div>

                </div>
              </div>

              <!-- ECO ONLY -->
              <div class="glass-soft p-3 mb-3 d-none" id="blockECO">
                <div class="d-flex justify-content-between align-items-baseline mb-2">
                  <div class="fw-bold">ECO</div>
                  <div class="small muted mono">ECO=((IDE+VAB+EXP)/PIB)*100</div>
                </div>
                <div class="row g-2">
                  <div class="col-6">
                    <label class="form-label small muted mb-1">IDE</label>
                    <input class="form-control" type="text" inputmode="decimal" data-key="IDE">
                  </div>
                  <div class="col-6">
                    <label class="form-label small muted mb-1">VAB</label>
                    <input class="form-control" type="text" inputmode="decimal" data-key="VAB">
                  </div>
                  <div class="col-6">
                    <label class="form-label small muted mb-1">EXP</label>
                    <input class="form-control" type="text" inputmode="decimal" data-key="EXP">
                  </div>
                  <div class="col-6">
                    <label class="form-label small muted mb-1">PIB</label>
                    <input class="form-control" type="text" inputmode="decimal" data-key="PIB">
                  </div>
                  <div class="mt-3">
                    <div class="small muted mb-2">
                      <i class="bi bi-link-45deg me-1"></i>Links / fuentes (PDF)
                    </div>
                    <div class="micro mt-2">
                      Excel aquí:
                      <a href="dataECO/5_Servicios.xlsx" target="_blank" rel="noopener"> Exportaciones</a>
                      <a href="dataECO/ID_Rama.xlsx" target="_blank" rel="noopener"> ,IDE</a>
                      <a href="dataECO/retropolacion_1965_2023.xlsx" target="_blank" rel="noopener"> ,VAP</a>  
                      <a href="dataACC/DATOS_CALCULADOS.xlsx" target="_blank" rel="noopener"> ,Datos_calculados</a>
                      <a href="dataECO/Calculos ECO, hasta desde 2020.xlsx" target="_blank" rel="noopener"> ,ECO_calculos</a>
                    </div>
                    <div class="micro mt-2">
                      PDF aquí:
                      <a href="dataECO/PIB Nominal Anual.pdf" target="_blank" rel="noopener"> PIB</a>
                    </div>
                  </div>
                </div>
              </div>

              <!-- PAY ONLY -->
              <div class="glass-soft p-3 mb-3 d-none" id="blockPAY">
                <div class="d-flex justify-content-between align-items-baseline mb-2">
                  <div class="fw-bold">PAY</div>
                  <div class="small muted mono">PAY = sqrt((GD/2) × (POS/(POS+RET))) × 100</div>
                </div>
                <div class="row g-2">
                  <div class="col-6">
                    <label class="form-label small muted mb-1">GD</label>
                    <input class="form-control" type="text" inputmode="decimal" data-key="GD" placeholder="Ej: 139.55 o 1.3955">
                  </div>
                  <div class="col-6">
                    <label class="form-label small muted mb-1">POS</label>
                    <input class="form-control" type="text" inputmode="decimal" data-key="POS">
                  </div>
                  <div class="col-6">
                    <label class="form-label small muted mb-1">RETIROS</label>
                    <input class="form-control" type="text" inputmode="decimal" data-key="RET">
                  </div>
                  <div class="mt-3">
                    <div class="small muted mb-2">
                      <i class="bi bi-link-45deg me-1"></i>Links / fuentes (PDF)
                    </div>
                    <div class="micro mt-2">
                      PDF aquí:
                      <a href="dataPAY/Sistema Pagos Interbancarios _ PIB.pdf" target="_blank" rel="noopener">Pagos_Interbancarios_GD</a>
                    </div>
                    <div class="micro mt-2">
                      Excel aquí:
                      <a href="dataPAY/POS/Puntos de Venta Electrónicos AÑO 2020 (1).xlsx" target="_blank" rel="noopener"> POS_2020</a>
                      <a href="dataPAY/POS/Puntos de Venta Electrónicos AÑO 2021.xlsx" target="_blank" rel="noopener"> ,POS_2021</a>
                      <a href="dataPAY/POS/Puntos de Venta Electrónicos AÑO 2022.xlsx" target="_blank" rel="noopener"> ,POS_2022</a>
                      <a href="dataPAY/POS/Puntos de Venta Electrónicos AÑO 2023.xlsx" target="_blank" rel="noopener"> ,POS_2023</a>
                    </div>
                     <div class="micro mt-2">
                      Excel aquí:
                      <a href="dataPAY/RETIROS/retiros-dinero-dic-2020.xlsx" target="_blank" rel="noopener"> RETIROS_2020</a>
                      <a href="dataPAY/RETIROS/retiros-dinero-dic-2021.xlsx" target="_blank" rel="noopener"> ,RETIROS_2021</a>
                      <a href="dataPAY/RETIROS/retiros-dinero-dic-2022.xlsx" target="_blank" rel="noopener"> ,RETIROS_2022</a>
                      <a href="dataPAY/RETIROS/retiros-dinero-dic-2023.xlsx" target="_blank" rel="noopener"> ,RETIROS_2023</a>
                      <a href="dataPAY/RETIROS/Retiros de Dinero DICIEMBRE 2024.xlsx" target="_blank" rel="noopener"> ,RETIROS_2024</a>
                    </div>
                  </div>
                </div>
              </div>

              <!-- IDE tab: results ONLY -->
              <div class="glass-soft p-3 mb-3" id="blockResultsIDE">
                <div class="d-flex justify-content-between align-items-baseline mb-2">
                  <div class="fw-bold">Resultados (año seleccionado)</div>
                  <span class="badge badge-soft rounded-pill">cálculos</span>
                </div>

                <div class="row g-2">
                  <div class="col-6">
                    <div class="small muted">GOV</div>
                    <div class="fw-bold" id="resGOV">—</div>
                  </div>
                  <div class="col-6">
                    <div class="small muted">ACC</div>
                    <div class="fw-bold" id="resACC">—</div>
                  </div>
                  <div class="col-6">
                    <div class="small muted">ECO</div>
                    <div class="fw-bold" id="resECO">—</div>
                  </div>
                  <div class="col-6">
                    <div class="small muted">PAY</div>
                    <div class="fw-bold" id="resPAY">—</div>
                  </div>
                  <div class="col-12">
                    <div class="small muted">IDE–EC</div>
                    <div class="fs-4 fw-bold" id="resIDE">—</div>
                  </div>
                </div>
              </div>

              <div class="alert glass small muted mb-0" id="yearNote"></div>

              <div class="mt-3" id="summaryWrap">
                <table class="table table-dark table-bordered table-sm align-middle mb-0" id="summaryTable">
                  <thead>
                    <tr>
                      <th>Año</th>
                      <th class="text-end">GOV</th>
                      <th class="text-end">ACC</th>
                      <th class="text-end">ECO</th>
                      <th class="text-end">PAY</th>
                      <th class="text-end">IDE–EC</th>
                    </tr>
                  </thead>
                  <tbody id="summaryBody"></tbody>
                </table>
              </div>

            </div>
          </div>

          <!-- RIGHT: KPI + CHART -->
          <div class="col-xl-7" id="rightPane">
            <div class="glass p-3">
              <div class="d-flex justify-content-between align-items-center">
                <div class="fw-bold" id="indicatorTitle">IDE–EC</div>
                <span class="badge badge-soft rounded-pill" id="indicatorBadge">—</span>
              </div>

              <div class="row g-2 mt-2">
                <div class="col-md-6">
                  <div class="glass-soft p-3 kpi kpi-highlight">
                    <div class="small muted">Año seleccionado</div>
                    <div class="big brandNumber mt-2" id="kpiSelected">—</div>
                    <div class="small muted mt-2" id="kpiSelectedHint">—</div>
                  </div>
                </div>
              </div>

              <div class="small muted mt-2" id="kpiNote">—</div>
            </div>

            <div class="glass p-3 mt-3">
              <div class="fw-bold mb-2" id="chartTitle">Tendencia</div>
              <div class="chartBox">
                <canvas id="singleBar"></canvas>
              </div>
            </div>

          </div>

        </div>
        
      </section>

      <!-- ✅ BENEFICIOS -->
      <section class="mt-3 d-none" id="viewBenefits">

<div class="glass p-3">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <div>
            <h2 class="h5 m-0 fw-bold">Beneficios de la digitalización (Ecuador)</h2>
            <div class="micro mt-1">Productividad, inclusión, competitividad y
                servicios públicos.</div>
        </div>
    </div>
</div>

<!-- Bloque 1 -->
<div class="glass p-3 mt-3">
    <div class="benefitText">
        <div class="benefit-section">Digitalización y desarrollo económico</div>

        <p>
            La digitalización económica se entiende como el proceso de incorporación sistemática de tecnologías
            digitales en la
            estructura productiva, institucional y social de un país. No se limita a la disponibilidad de
            infraestructura tecnológica
            o servicios en línea, sino que implica la integración efectiva de herramientas digitales en la generación de
            valor,
            la gestión pública y la competitividad empresarial.
        </p>

        <p class="mb-2">
            La transformación digital suele impactar directamente en:
        </p>

        <ul class="benefit-list">
            <li>Reducción de costos de transacción y tiempos operativos.</li>
            <li>Eficiencia administrativa en el sector público y privado.</li>
            <li>Expansión de mercados (más alcance para ventas y exportación).</li>
            <li>Inclusión financiera y acceso a servicios digitales.</li>
            <li>Innovación productiva (nuevos productos, procesos y modelos de negocio).</li>
        </ul>

        <p>
            Sin embargo, la digitalización no produce automáticamente desarrollo económico. Su impacto depende de
            factores estructurales
            como la calidad institucional, el capital humano, la infraestructura, la regulación, la competencia y la
            capacidad real de adopción
            tecnológica de empresas y ciudadanía.
        </p>

        <p class="mb-0">
            En este contexto, medir el nivel de digitalización —mediante gobierno digital, acceso tecnológico, economía
            digital y pagos electrónicos—
            permite evaluar el grado de modernización tecnológica y su potencial para impulsar productividad y
            crecimiento sostenible.
        </p>
    </div>
</div>

<!-- Bloque 2 -->
<div class="glass p-3 mt-3">
    <div class="benefitText">
        <div class="benefit-section">Sectores y actores que se benefician</div>

        <div class="benefit-sub">1) Sector financiero y fintech</div>
        <p>Mayor bancarización, pagos digitales y reducción del uso de efectivo:</p>
        <ul class="benefit-list">
            <li><b>Bancos</b>: fortalecimiento de banca móvil, pagos en línea y automatización de servicios.</li>
            <li><b>Fintech</b>: crecimiento en procesamiento de transacciones, e-commerce y pagos QR.</li>
            <li><b>Crédito digital</b>: impulso a inclusión financiera, scoring alternativo y microcrédito.</li>
        </ul>

        <div class="benefit-sub">2) Retail y comercio electrónico</div>
        <p>Expansión omnicanal y optimización operativa:</p>
        <ul class="benefit-list">
            <li>Más ventas por canales digitales (web, apps, marketplaces).</li>
            <li>Mejor trazabilidad de inventario y logística integrada.</li>
            <li>Mejor experiencia de usuario (personalización, tiempos, atención).</li>
        </ul>

        <div class="benefit-sub">3) Logística y última milla</div>
        <p>Mejor trazabilidad, tiempos de entrega y experiencia de usuario:</p>
        <ul class="benefit-list">
            <li>Seguimiento en tiempo real (tracking) y optimización de rutas.</li>
            <li>Más demanda por crecimiento del e-commerce y servicios on-demand.</li>
        </ul>

        <div class="benefit-sub">4) Telecomunicaciones y conectividad</div>
        <p>Infraestructura clave para habilitar el ecosistema digital:</p>
        <ul class="benefit-list">
            <li>Expansión de redes (4G/5G), fibra óptica y conectividad rural.</li>
            <li>Mayor consumo de datos y servicios digitales en hogares y empresas.</li>
        </ul>

        <div class="benefit-sub">5) Software, consultoría y servicios digitales</div>
        <p>Mayor demanda de transformación y automatización:</p>
        <ul class="benefit-list">
            <li>Digitalización de procesos, migración a la nube y ciberseguridad.</li>
            <li>Analítica de datos, automatización, IA y capacitación de talento.</li>
        </ul>

        <div class="benefit-sub">6) Sector público</div>
        <p>Mejora de eficiencia, trazabilidad y servicios al ciudadano:</p>
        <ul class="benefit-list">
            <li>Trámites en línea y reducción de costos administrativos.</li>
            <li>Interoperabilidad de datos y mayor transparencia.</li>
            <li>Servicios más accesibles para ciudadanía y empresas.</li>
        </ul>

        <div class="benefit-sub">¿Por qué se benefician?</div>
        <ul class="benefit-list mb-0">
            <li><b>Más clientes conectados</b>: mayor adopción de servicios digitales.</li>
            <li><b>Reducción de costos</b>: menos errores, menos papel, más automatización.</li>
            <li><b>Innovación</b>: nuevos productos/servicios y mejor toma de decisiones con datos.</li>
            <li><b>Competitividad</b>: capacidad de competir, atraer inversión y crecer.</li>
        </ul>
    </div>
</div>

<!-- Bloque 3 -->
<div class="glass p-3 mt-3">
    <div class="benefitText">
        <div class="benefit-section">Beneficios clave medibles</div>

        <div class="benefit-sub">Productividad y eficiencia</div>
        <ul class="benefit-list">
            <li>Automatización de tareas repetitivas y reducción de tiempos.</li>
            <li>Mejor coordinación entre áreas (ventas, logística, finanzas).</li>
            <li>Menos costos operativos por digitalización de procesos.</li>
        </ul>

        <div class="benefit-sub">Inclusión e igualdad de oportunidades</div>
        <ul class="benefit-list">
            <li>Acceso a educación, salud, banca y servicios públicos en línea.</li>
            <li>Mayor participación de MIPYMES en el mercado digital.</li>
            <li>Reducción de barreras geográficas (especialmente en zonas rurales).</li>
        </ul>

        <div class="benefit-sub">Confianza y trazabilidad</div>
        <ul class="benefit-list">
            <li>Pagos electrónicos con registro, control y mejor auditoría.</li>
            <li>Menor informalidad y mejores mecanismos de control tributario.</li>
            <li>Mejor seguimiento de procesos (trámites, entregas, reclamos).</li>
        </ul>

        <div class="benefit-sub">Innovación y diversificación productiva</div>
        <ul class="benefit-list mb-0">
            <li>Nuevos modelos de negocio (suscripción, marketplaces, servicios bajo demanda).</li>
            <li>Mayor adopción de soluciones basadas en datos e inteligencia artificial.</li>
            <li>Mayor capacidad de exportar servicios digitales y atraer alianzas.</li>
        </ul>
    </div>
</div>

<!-- Bloque 4 -->
<div class="glass p-3 mt-3">
    <div class="benefitText">
        <div class="benefit-section">Riesgos y condiciones para que funcione (muy importante)</div>

        <p class="mb-2">
            Para que los beneficios se materialicen, se requieren condiciones mínimas:
        </p>

        <ul class="benefit-list">
            <li><b>Conectividad</b>: acceso real (calidad, estabilidad, costo) y cobertura.</li>
            <li><b>Habilidades digitales</b>: formación para uso productivo (no solo consumo).</li>
            <li><b>Seguridad</b>: ciberseguridad, protección de datos y confianza digital.</li>
            <li><b>Regulación y competencia</b>: marcos claros para innovación y mercados abiertos.</li>
            <li><b>Adopción empresarial</b>: MIPYMES con capacidades para integrar tecnología.</li>
        </ul>

        <p class="mb-0">
            Si estas condiciones no se cumplen, la digitalización puede aumentar brechas (entre urbano/rural,
            grandes/pequeñas empresas,
            y población con/sin habilidades digitales). Por eso, medir y comparar indicadores permite identificar
            prioridades de política pública
            y decisiones de inversión.
        </p>
    </div>
</div>

<!-- Logos al final -->
<div class="glass p-3 mt-3">
    <div class="logoGrid mt-3">

        <!-- Banco Pichincha -->
        <div class="logoCard glass-soft p-3">
            <div class="logoWrap">
                <img src="https://logo.clearbit.com/bancopichincha.com" alt="Banco Pichincha" loading="lazy"
                    referrerpolicy="no-referrer"
                    onerror="this.remove(); this.parentElement.querySelector('.logoFallback').style.display='flex';" />
                <div class="logoFallback" style="display:none;">BP</div>
            </div>
            <div class="logoName">Banco Pichincha</div>
        </div>

        <!-- Claro -->
        <div class="logoCard glass-soft p-3">
            <div class="logoWrap">
                <img src="https://logo.clearbit.com/claro.com.ec" alt="Claro Ecuador" loading="lazy"
                    referrerpolicy="no-referrer"
                    onerror="this.remove(); this.parentElement.querySelector('.logoFallback').style.display='flex';" />
                <div class="logoFallback" style="display:none;">CL</div>
            </div>
            <div class="logoName">Claro Ecuador</div>
        </div>

        <!-- Kushki -->
        <div class="logoCard glass-soft p-3">
            <div class="logoWrap">
                <img src="https://logo.clearbit.com/kushkipagos.com" alt="Kushki" loading="lazy"
                    referrerpolicy="no-referrer"
                    onerror="this.remove(); this.parentElement.querySelector('.logoFallback').style.display='flex';" />
                <div class="logoFallback" style="display:none;">K</div>
            </div>
            <div class="logoName">Kushki</div>
        </div>

        <!-- Mercado Libre -->
        <div class="logoCard glass-soft p-3">
            <div class="logoWrap">
                <img src="https://logo.clearbit.com/mercadolibre.com" alt="Mercado Libre" loading="lazy"
                    referrerpolicy="no-referrer"
                    onerror="this.remove(); this.parentElement.querySelector('.logoFallback').style.display='flex';" />
                <div class="logoFallback" style="display:none;">ML</div>
            </div>
            <div class="logoName">Mercado Libre</div>
        </div>

        <!-- Movistar -->
        <div class="logoCard glass-soft p-3">
            <div class="logoWrap">
                <img src="https://logo.clearbit.com/movistar.com" alt="Movistar" loading="lazy"
                    referrerpolicy="no-referrer"
                    onerror="this.remove(); this.parentElement.querySelector('.logoFallback').style.display='flex';" />
                <div class="logoFallback" style="display:none;">MV</div>
            </div>
            <div class="logoName">Movistar</div>
        </div>

        <!-- SRI -->
        <div class="logoCard glass-soft p-3">
            <div class="logoWrap">
                <img src="https://logo.clearbit.com/sri.gob.ec" alt="SRI" loading="lazy" referrerpolicy="no-referrer"
                    onerror="this.remove(); this.parentElement.querySelector('.logoFallback').style.display='flex';" />
                <div class="logoFallback" style="display:none;">SRI</div>
            </div>
            <div class="logoName">Servicio de Rentas Internas (SRI)</div>
        </div>

    </div>
</div>

</section>
    </main>
  </div>
</div>

<script>
  let singleChart = null;

  const THEME_KEY = "ideec_theme";

  function applyTheme(theme){
    document.documentElement.setAttribute("data-theme", theme);
    const icon = document.getElementById("themeIcon");
    const label = document.getElementById("themeLabel");
    const isDark = theme === "dark";
    icon.className = isDark ? "bi bi-moon-stars-fill" : "bi bi-sun-fill";
    label.textContent = isDark ? "Noche" : "Día";

    updateChartTheme();
    if(singleChart) singleChart.update();
  }

  function initTheme(){
    const saved = localStorage.getItem(THEME_KEY);
    if(saved){ applyTheme(saved); return; }
    applyTheme("light");
  }

  document.getElementById("themeToggle").addEventListener("click", ()=>{
    const current = document.documentElement.getAttribute("data-theme") || "light";
    const next = current === "dark" ? "light" : "dark";
    localStorage.setItem(THEME_KEY, next);
    applyTheme(next);
  });

  function cssVar(name){
    return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
  }

  function parseSmartNumber(raw){
    if(raw === null || raw === undefined) return null;
    let s = String(raw).trim();
    if(s === "") return null;
    s = s.replace(/\s+/g, "");
    const lastComma = s.lastIndexOf(",");
    const lastDot   = s.lastIndexOf(".");
    const lastSep = Math.max(lastComma, lastDot);
    if(lastSep !== -1){
      const intPart = s.slice(0, lastSep).replace(/[.,]/g, "");
      const decPart = s.slice(lastSep + 1).replace(/[.,]/g, "");
      s = intPart + "." + decPart;
    }
    const n = Number(s);
    return Number.isNaN(n) ? null : n;
  }

  function normWeight(v){
    if(v===null || v===undefined) return null;
    const n = Number(v);
    if(Number.isNaN(n)) return null;
    if(n > 1) return n / 100;
    return n;
  }

  function gdToDecimal(gd){
    if(gd===null || gd===undefined) return null;
    const n = Number(gd);
    if(Number.isNaN(n)) return null;
    if(n > 2) return n / 100;
    return n;
  }

  function calcGOV(r){
    const {OSI,TII,HCI} = r;
    if([OSI,TII,HCI].some(v=>v===null)) return null;
    return (OSI+TII+HCI)/3;
  }

  function calcACC(r) {
    const { IH, UI, CA, SP, AI } = r;
    if ([IH, UI, CA, SP, AI].some(v => v === null)) return null;
    const resultado = (IH + UI + CA + SP + (1 - AI)) / 5;
    return resultado / 100; // (lo dejé como lo tenías)
  }

  function calcECO(r){
    const {IDE,VAB,EXP,PIB} = r;
    if([IDE,VAB,EXP,PIB].some(v=>v===null)) return null;
    if(PIB===0) return null;
    return ((IDE+VAB+EXP)/PIB)*100;
  }

  function calcPAY(r){
    const {GD,POS,RET} = r;
    if([GD,POS,RET].some(v=>v===null)) return null;
    const denom = POS + RET;
    if(denom===0) return null;

    const gdDec = gdToDecimal(GD);
    if(gdDec===null) return null;

    const GDnorm = gdDec / 2;
    const CS = POS / denom;
    const prod = GDnorm * CS;
    if(prod < 0) return null;

    return Math.sqrt(prod) * 100;
  }

  function calcIDE_EC(r) {
    const wGOV = normWeight(r.wGOV);
    const wACC = normWeight(r.wACC);
    const wECO = normWeight(r.wECO);
    const wPAY = normWeight(r.wPAY);
    const { GOV, ACC, ECO, PAY } = r;

    if ([wGOV, wACC, wECO, wPAY, GOV, ACC, ECO, PAY].some(v => v === null)) return null;

    return (wGOV * (GOV * 100)) +
           (wACC * (ACC * 100)) +
           (wECO * ECO) +
           (wPAY * PAY);
  }

  const DEFAULT_YEAR = 2020;
  function mkRow(year){
    return {
      year,
      OSI:null,TII:null,HCI:null,
      IH:null,UI:null,CA:null,SP:null,AI:null,
      IDE:null,VAB:null,EXP:null,PIB:null,
      GD:null,POS:null,RET:null,
      wGOV:null,wACC:null,wECO:null,wPAY:null,
      GOV:null,ACC:null,ECO:null,PAY:null,IDE_EC:null
    };
  }

  let rows = [ mkRow(DEFAULT_YEAR) ];
  let selectedYear = DEFAULT_YEAR;
  let currentTab = "ide";

  const STORAGE_KEY = "ideec_rows_v1";
  const STORAGE_YEAR_KEY = "ideec_selected_year_v1";

  function saveToStorage(){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(rows));
      localStorage.setItem(STORAGE_YEAR_KEY, String(selectedYear));
    }catch(e){
      console.warn("No se pudo guardar en localStorage:", e);
    }
  }

  function loadFromStorage(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      const rawYear = localStorage.getItem(STORAGE_YEAR_KEY);

      if(raw){
        const parsed = JSON.parse(raw);
        if(Array.isArray(parsed) && parsed.length){
          rows = parsed.map(r => ({ ...mkRow(r.year ?? DEFAULT_YEAR), ...r }));
        }
      }

      if(rawYear){
        const y = Number(rawYear);
        if(!Number.isNaN(y)) selectedYear = y;
      }
    }catch(e){
      console.warn("No se pudo cargar desde localStorage:", e);
    }
  }

  const fmtGovAcc = v => v===null ? "—" : Number(v).toFixed(4);
  const fmtPctInt = v => v===null ? "—" : `${Math.round(v)}%`;
  const fmtIde = v => v===null ? "—" : `${Number(v).toFixed(2)}%`;

  const menuBtns = Array.from(document.querySelectorAll("#menu .nav-link"));
  const pageDesc = document.getElementById("pageDesc");

  const viewIndicator = document.getElementById("viewIndicator");
  const viewBenefits = document.getElementById("viewBenefits");

  const yearSelect = document.getElementById("yearSelect");
  const prevYearBtn = document.getElementById("prevYearBtn");
  const nextYearBtn = document.getElementById("nextYearBtn");

  const summaryBody = document.getElementById("summaryBody");
  const yearNote = document.getElementById("yearNote");
  const wNote = document.getElementById("wNote");
  const accBreakdown = document.getElementById("accBreakdown");

  const indicatorTitle = document.getElementById("indicatorTitle");
  const indicatorBadge = document.getElementById("indicatorBadge");
  const chartTitle = document.getElementById("chartTitle");

  const kpiSelected = document.getElementById("kpiSelected");
  const kpiSelectedHint = document.getElementById("kpiSelectedHint");
  const kpiNote = document.getElementById("kpiNote");

  const blockIDE = document.getElementById("blockIDE");
  const blockGOV = document.getElementById("blockGOV");
  const blockACC = document.getElementById("blockACC");
  const blockECO = document.getElementById("blockECO");
  const blockPAY = document.getElementById("blockPAY");
  const blockResultsIDE = document.getElementById("blockResultsIDE");

  const resGOV = document.getElementById("resGOV");
  const resACC = document.getElementById("resACC");
  const resECO = document.getElementById("resECO");
  const resPAY = document.getElementById("resPAY");
  const resIDE = document.getElementById("resIDE");

  function setTab(tab){
    currentTab = tab;
    menuBtns.forEach(b=>b.classList.toggle("active", b.dataset.tab===tab));

    const isBenefits = tab === "benef";
    viewIndicator.classList.toggle("d-none", isBenefits);
    viewBenefits.classList.toggle("d-none", !isBenefits);

    if(isBenefits){
      pageDesc.textContent = "Beneficios";
      return;
    }

    const isIDE = tab === "ide";
    blockIDE.classList.toggle("d-none", !isIDE);
    blockResultsIDE.classList.toggle("d-none", !isIDE);

    blockGOV.classList.toggle("d-none", tab !== "gov");
    blockACC.classList.toggle("d-none", tab !== "acc");
    blockECO.classList.toggle("d-none", tab !== "eco");
    blockPAY.classList.toggle("d-none", tab !== "pay");

    if(tab==="ide"){
      pageDesc.textContent = "IDE–EC: edita pesos y revisa resultados (GOV/ACC/ECO/PAY) del año.";
      indicatorTitle.textContent = "IDE–EC";
      indicatorBadge.textContent = "pesos";
      chartTitle.textContent = "Tendencia IDE–EC";
    }
    if(tab==="gov"){
      pageDesc.textContent = "GOV: ingresa OSI, TII y HCI.";
      indicatorTitle.textContent = "GOV";
      indicatorBadge.textContent = "0–1";
      chartTitle.textContent = "Tendencia GOV";
    }
    if(tab==="acc"){
      pageDesc.textContent = "ACC: ingresa IH, UI, CA, SP y AI.";
      indicatorTitle.textContent = "ACC";
      indicatorBadge.textContent = "0–1";
      chartTitle.textContent = "Tendencia ACC";
    }
    if(tab==="eco"){
      pageDesc.textContent = "ECO: ingresa IDE, VAB, EXP y PIB.";
      indicatorTitle.textContent = "ECO";
      indicatorBadge.textContent = "%";
      chartTitle.textContent = "Tendencia ECO";
    }
    if(tab==="pay"){
      pageDesc.textContent = "PAY: ingresa GD, POS y RETIROS.";
      indicatorTitle.textContent = "PAY";
      indicatorBadge.textContent = "%";
      chartTitle.textContent = "Tendencia PAY";
    }

    fillInputsFromRow();
    updateAccBreakdown();
    updateWeightsNote();
    updateIndicatorKPI();
    updateIDEPanelResults();
    updateSingleChart();
    updateYearNote();
  }

  menuBtns.forEach(btn => btn.addEventListener("click", ()=> setTab(btn.dataset.tab)));

  function renderYearSelect(){
    yearSelect.innerHTML = rows.slice().sort((a,b)=>a.year-b.year)
      .map(r=> `<option value="${r.year}" ${r.year===selectedYear?"selected":""}>${r.year}</option>`)
      .join("");
  }

  function getCurrentRow(){
    return rows.find(r=>r.year===selectedYear) ?? rows[0];
  }

  function fillInputsFromRow(){
    const r = getCurrentRow();
    document.querySelectorAll('input[data-key]').forEach(inp=>{
      const k = inp.dataset.key;
      inp.value = (r[k]===null || r[k]===undefined) ? "" : r[k];
    });
  }

  function recomputeRow(r){
    r.GOV = calcGOV(r);
    r.ACC = calcACC(r);
    r.ECO = calcECO(r);
    r.PAY = calcPAY(r);
    r.IDE_EC = calcIDE_EC(r);
  }

  function recomputeAll(){
    rows = rows.map(r=>{
      const rr = {...r};
      recomputeRow(rr);
      return rr;
    }).sort((a,b)=>a.year-b.year);

    if(!rows.find(r=>r.year===selectedYear)){
      selectedYear = rows.at(-1)?.year ?? DEFAULT_YEAR;
    }

    renderYearSelect();
    renderSummary();
    updateAccBreakdown();
    updateWeightsNote();
    updateIndicatorKPI();
    updateIDEPanelResults();
    updateSingleChart();
    updateYearNote();
    fillInputsFromRow();
    yearSelect.value = String(selectedYear);
  }

  function goToYear(year){
    const exists = rows.some(r => r.year === year);
    if(!exists) return;

    selectedYear = year;
    renderYearSelect();
    yearSelect.value = String(selectedYear);

    fillInputsFromRow();
    updateAccBreakdown();
    updateWeightsNote();
    updateIndicatorKPI();
    updateIDEPanelResults();
    updateSingleChart();
    updateYearNote();

    saveToStorage();
  }

  prevYearBtn.addEventListener("click", ()=>{
    const years = rows.map(r=>r.year).sort((a,b)=>a-b);
    const idx = years.indexOf(selectedYear);
    if(idx > 0) goToYear(years[idx - 1]);
  });

  nextYearBtn.addEventListener("click", ()=>{
    const years = rows.map(r=>r.year).sort((a,b)=>a-b);
    const idx = years.indexOf(selectedYear);
    if(idx !== -1 && idx < years.length - 1) goToYear(years[idx + 1]);
  });

  yearSelect.addEventListener("change", ()=>{
    selectedYear = Number(yearSelect.value);
    fillInputsFromRow();
    updateAccBreakdown();
    updateWeightsNote();
    updateIndicatorKPI();
    updateIDEPanelResults();
    updateSingleChart();
    updateYearNote();
    saveToStorage();
  });

  function renderSummary(){
    summaryBody.innerHTML = rows.map(r=>`
      <tr>
        <td>
          <button
            type="button"
            class="btn btn-soft btn-sm py-1 px-2"
            data-year="${r.year}"
            title="Ir a ${r.year}">
            ${r.year}
          </button>
        </td>
        <td class="text-end">${fmtGovAcc(r.GOV)}</td>
        <td class="text-end">${fmtGovAcc(r.ACC)}</td>
        <td class="text-end">${fmtPctInt(r.ECO)}</td>
        <td class="text-end">${fmtPctInt(r.PAY)}</td>
        <td class="text-end">${fmtIde(r.IDE_EC)}</td>
      </tr>
    `).join("");
  }

  summaryBody.addEventListener("click", (e)=>{
    const btn = e.target.closest("button[data-year]");
    if(!btn) return;
    const y = Number(btn.dataset.year);
    if(Number.isNaN(y)) return;
    goToYear(y);
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  function updateYearNote(){
    const r = getCurrentRow();
    const msgs = [];

    if(r.PIB===0) msgs.push("PIB=0 → ECO no se calcula.");
    if(r.POS!==null && r.RET!==null && (r.POS+r.RET)===0) msgs.push("POS+RET=0 → PAY no se calcula.");

    if([r.wGOV,r.wACC,r.wECO,r.wPAY].some(v=>v===null)) msgs.push("Faltan pesos para IDE–EC.");
    if([r.GOV,r.ACC,r.ECO,r.PAY].some(v=>v===null)) msgs.push("Faltan indicadores base para IDE–EC.");

    yearNote.innerHTML = msgs.length ? `<b>Revisión:</b> ${msgs.join(" ")}` : "Completa los datos del año seleccionado.";
  }

  function updateWeightsNote(){
    const r = getCurrentRow();
    const wRaw = [r.wGOV,r.wACC,r.wECO,r.wPAY];
    if(wRaw.some(v=>v===null)){ wNote.innerHTML = "Ingresa los pesos (puedes poner 0.25 o 25)."; return; }
    const w = wRaw.map(normWeight);
    if(w.some(v=>v===null)){ wNote.innerHTML = "Hay un peso inválido."; return; }
    const sum = w.reduce((a,b)=>a+b,0);
    wNote.innerHTML = `Suma de pesos = <b>${sum.toFixed(2)}</b> (recomendado 1.00)`;
  }

  function updateAccBreakdown(){
    if(!accBreakdown) return;
    const r = getCurrentRow();
    const keys = ["IH","UI","CA","SP","AI"];
    if(keys.some(k=>r[k]===null)){
      accBreakdown.textContent = "Completa IH, UI, CA, SP y AI para ver el desglose.";
      return;
    }
    const invAI = 1 - r.AI;
    const sum = r.IH + r.UI + r.CA + r.SP + invAI;
    const acc = sum/5;
    accBreakdown.innerHTML = `<b>Desglose:</b> suma=${sum.toFixed(4)} → /5 = <b>${acc.toFixed(4)}</b>`;
  }

  function getIndicatorValue(r){
    if(currentTab==="ide") return r.IDE_EC;
    if(currentTab==="gov") return r.GOV;
    if(currentTab==="acc") return r.ACC;
    if(currentTab==="eco") return r.ECO;
    if(currentTab==="pay") return r.PAY;
    return null;
  }

  function formatIndicatorValue(v){
    if(v===null) return "—";
    if(currentTab==="gov" || currentTab==="acc") return Number(v).toFixed(4);
    if(currentTab==="eco" || currentTab==="pay") return `${Math.round(v)}%`;
    if(currentTab==="ide") return `${Number(v).toFixed(2)}%`;
    return String(v);
  }

  function updateIndicatorKPI(){
    const rSel = getCurrentRow();
    kpiSelected.textContent = formatIndicatorValue(getIndicatorValue(rSel));
    kpiSelectedHint.textContent = `Año ${rSel.year}`;

    const notes = [];
    if(rSel.PIB===0) notes.push("PIB=0");
    if(rSel.POS!==null && rSel.RET!==null && (rSel.POS+rSel.RET)===0) notes.push("POS+RET=0");
    if([rSel.wGOV,rSel.wACC,rSel.wECO,rSel.wPAY].some(v=>v===null)) notes.push("pesos incompletos");
    if([rSel.GOV,rSel.ACC,rSel.ECO,rSel.PAY].some(v=>v===null)) notes.push("faltan base");
    kpiNote.textContent = notes.length ? `Validaciones: ${notes.join(" · ")}` : "Validaciones: OK";
  }

  function updateIDEPanelResults(){
    const r = getCurrentRow();
    resGOV.textContent = fmtGovAcc(r.GOV);
    resACC.textContent = fmtGovAcc(r.ACC);
    resECO.textContent = fmtPctInt(r.ECO);
    resPAY.textContent = fmtPctInt(r.PAY);
    resIDE.textContent = fmtIde(r.IDE_EC);
  }

  const chartTheme = {
    legend: "#111827",
    tick: "#334155",
    grid: "rgba(15, 23, 42, .08)"
  };

  function updateChartTheme(){
    chartTheme.legend = cssVar("--txt") || "#111827";
    chartTheme.tick = cssVar("--tick") || "#334155";
    chartTheme.grid = cssVar("--grid") || "rgba(15, 23, 42, .08)";

    if(singleChart){
      singleChart.options.plugins.legend.labels.color = chartTheme.legend;
      singleChart.options.scales.x.ticks.color = chartTheme.tick;
      singleChart.options.scales.y.ticks.color = chartTheme.tick;
      singleChart.options.scales.x.grid.color = chartTheme.grid;
      singleChart.options.scales.y.grid.color = chartTheme.grid;
    }
  }

  function buildSingleBar(canvas, labels, data, yTitle){
    const ctx = canvas.getContext("2d");
    const grad = ctx.createLinearGradient(0, 0, 0, canvas.height || 300);
    grad.addColorStop(0, cssVar("--brand1"));
    grad.addColorStop(1, cssVar("--brand2"));

    return new Chart(canvas, {
      type: "bar",
      data: { labels, datasets: [{ label: yTitle, data, borderWidth: 0, borderRadius: 10, backgroundColor: grad }] },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        plugins:{ legend:{ labels:{ color: chartTheme.legend } } },
        scales:{
          x:{ ticks:{ color: chartTheme.tick }, grid:{ color: chartTheme.grid } },
          y:{ ticks:{ color: chartTheme.tick }, grid:{ color: chartTheme.grid } }
        }
      }
    });
  }

  function updateSingleChart(){
    const labels = rows.map(r=>String(r.year));
    const data = rows.map(r => getIndicatorValue(r));

    let yTitle = "IDE–EC (%)";
    if(currentTab==="gov") yTitle="GOV";
    if(currentTab==="acc") yTitle="ACC";
    if(currentTab==="eco") yTitle="ECO (%)";
    if(currentTab==="pay") yTitle="PAY (%)";

    const canvas = document.getElementById("singleBar");
    if(singleChart){
      singleChart.data.labels = labels;
      singleChart.data.datasets[0].label = yTitle;
      singleChart.data.datasets[0].data = data;

      const ctx = canvas.getContext("2d");
      const grad = ctx.createLinearGradient(0, 0, 0, canvas.height || 300);
      grad.addColorStop(0, cssVar("--brand1"));
      grad.addColorStop(1, cssVar("--brand2"));
      singleChart.data.datasets[0].backgroundColor = grad;

      updateChartTheme();
      singleChart.update();
    } else {
      updateChartTheme();
      singleChart = buildSingleBar(canvas, labels, data, yTitle);
    }
  }

  function attachInputListeners(){
    document.querySelectorAll('input[data-key]').forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const key = inp.dataset.key;
        const val = parseSmartNumber(inp.value);
        const r = getCurrentRow();
        r[key] = val;

        recomputeRow(r);
        renderSummary();
        updateAccBreakdown();
        updateWeightsNote();
        updateIndicatorKPI();
        updateIDEPanelResults();
        updateSingleChart();
        updateYearNote();

        saveToStorage();
      });
    });
  }

  document.getElementById("addYearBtn").addEventListener("click", ()=>{
    const maxY = Math.max(...rows.map(r=>r.year));
    const next = maxY + 1;
    rows.push(mkRow(next));
    selectedYear = next;
    recomputeAll();
    saveToStorage();
  });

  document.getElementById("clearBtn").addEventListener("click", ()=>{
    rows = [ mkRow(DEFAULT_YEAR) ];
    selectedYear = DEFAULT_YEAR;
    recomputeAll();
    setTab("ide");

    localStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem(STORAGE_YEAR_KEY);
  });

  function init(){
    initTheme();
    loadFromStorage();
    recomputeAll();
    attachInputListeners();
    setTab("ide");
    updateChartTheme();
  }
  init();
</script>

</body>
</html>